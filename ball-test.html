<!doctype html>
<html>
  <head>

  	<style>

	</style>

  <script src="js/jquery-1.11.3.min.js"></script>
  <script src="js/d3.min.js"></script>

  <!--<script type="text/paperscript" canvas="canvas">-->
  <script type="text/javascript">

	$(document).ready(function () {

		// TODO: Once the document has loaded get the canvas size 
		// var width = $("#canvas").width();
		// var height = $("#canvas").height();

		var width = 950, height = 500;

		// This will let us know if the user is moving the stylus around
		var moving = false;

		// The svg canvas we'll be using 
		var svg = d3.select("body").append("svg")
		    .attr("width", width)
		    .attr("height", height)
		    .attr("id", "svg-canvas");

		/* Create the haplet */

		// Draw the tablet  
		var tablet = function () {
			var tab = {};

			// Variables controlling size
			tab.length = 600;
			tab.width = tab.length / 1.4;
			tab.padding = 35;
			tab.top = {x: (width / 2) - (tab.length / 2), y: 30};

			// The black outline of the tablet 
			tab.casing = svg.append("rect")
					.attr("x", tab.top.x)
					.attr("y", tab.top.y)
					.attr("width", tab.length)
					.attr("height", tab.width)
					.attr("rx", 23).attr("ry", 23)
					.style("fill", "white")
					.style("stroke", "grey")
					.style("stroke-width", 2);

			// The screen of the tablet 
			tab.screen = svg.append("rect")
						.attr("x", tab.top.x + tab.padding)
						.attr("y", tab.top.y + tab.padding)
						.attr("width", tab.length - (tab.padding * 2))
						.attr("height", tab.width - (tab.padding * 2))
						.style("fill", "white")
						.style("stroke", "grey")
						.style("stroke-width", 2);

			// On button 
			var button_x = tab.top.x + 15;
			var button_y = tab.width / 2 + 30;
			tab.button = svg.append("circle")
						.attr("cx", button_x).attr("cy", button_y)
						.attr("r", 10)
						.style("fill", "white")
						.style("stroke", "grey")
						.style("stroke-width", 2);

			return tab;
		}();

		// Draw the balls 
		var balls = function () {
			
		}();

		// Draw the haplet 
		var haplet = function () {
			var hap = {};

			// Position and size variables 
			hap.arm_size = 185;
			hap.mid = mid = tablet.top.x + (tablet.length / 2);
			var gap = 50, top_offset = 14;
			var axis_length = (Math.sqrt(Math.pow(hap.arm_size, 2) - Math.pow(gap, 2))) * 2;
			hap.start_pos = {x: mid, y: tablet.top.y + top_offset};
			hap.bottom_pos = {x: mid, y: hap.start_pos.y + axis_length};

			// Where the joints will be 
			var joint1 = {x: hap.start_pos.x - gap, y: hap.start_pos.y + hap.arm_size};
			var joint2 = {x: hap.start_pos.x + gap, y: hap.start_pos.y + hap.arm_size};

			// Draw the arms
			hap.arm1 = svg.append("line")
						.attr("x1", hap.start_pos.x)
						.attr("y1", hap.start_pos.y)
						.attr("x2", joint1.x)
						.attr("y2", joint1.y);
			hap.arm2 = svg.append("line")
						.attr("x1", hap.start_pos.x)
						.attr("y1", hap.start_pos.y)
						.attr("x2", joint2.x)
						.attr("y2", joint2.y);
			hap.arm3 = svg.append("line")
						.attr("x1", joint1.x)
						.attr("y1", joint1.y)
						.attr("x2", hap.bottom_pos.x)
						.attr("y2", hap.bottom_pos.y);
			hap.arm4 = svg.append("line")
						.attr("x1", joint2.x)
						.attr("y1", joint2.y)
						.attr("x2", hap.bottom_pos.x)
						.attr("y2", hap.bottom_pos.y);

			// Draw the stylus 
			hap.stylus = svg.append("circle")
						.attr("cx", hap.bottom_pos.x)
						.attr("cy", hap.bottom_pos.y)
						.attr("r", 15)
						.attr("id", "stylus")
						.style("stroke", "grey")
						.style("stroke-width", 2)
						.style("fill", "white")
						.style("opacity", 0.85)
						// We can now move the stylus around 
						.on("mousedown", function () {
							moving = true;
						});

			/* Style the components */

			// Arm styling 
			var arm_style = function (arm, color) {
				return arm.attr("stroke", color)
						.attr("stroke-width", 20)
						.attr("stroke-linecap", "round")
						.style("stroke-opacity", 0.7);
			};

			arm_style(hap.arm1, "#87CEFA");
			arm_style(hap.arm2, "#87CEFA");
			arm_style(hap.arm3, "#191970");
			arm_style(hap.arm4, "#191970");

			hap.color_changer = setInterval(function () {
				// TO DO : fade the arm colors 
			}, 500);

			return hap;

		}();

		/* Movement functionality */

		// Compute distance between joint and center 
		var joint_dist = function (x) {
			return Math.sqrt(Math.pow(haplet.arm_size, 2) - Math.pow(x / 2.0, 2)) || 0;
		};

		// True if we're in the tablet frame 
		var in_tablet = function (coords) {
			var min_x = tablet.top.x + tablet.padding;
			var max_x = tablet.top.x + tablet.length - tablet.padding;
			var min_y = tablet.top.y + tablet.padding;
			var max_y = tablet.top.y + tablet.width - tablet.padding;
			var in_x = coords[0] >= min_x && coords[0] <= max_x;
			var in_y = coords[1] >= min_y && coords[1] <= max_y;
			return in_x && in_y;
		};

		// True if we're below the halfway point
		var below_half = function (coords) {
			return coords[1] >= tablet.top.y + (tablet.width / 2);
		};

		d3.select("#svg-canvas").on("mousemove", function (event) {
			// Only move everything if we've already clicked on the stylus
			// and within the movable frame  
			var coords = d3.mouse(this);

			// Don't move past the halfway line 
			if (moving && in_tablet(coords) && below_half(coords)) {
				// Move the stylus
				haplet.stylus.attr("cy", coords[1]);

				// Get the top to bottom length
				var l = coords[1] - tablet.top.y;

				// Calculate the length-wise distance the joint must move
				var d = joint_dist(l);

				// Move the joint/arms
				haplet.arm1.attr("x2", haplet.mid - d);
				haplet.arm2.attr("x2", haplet.mid + d);
				haplet.arm3.attr("x1", haplet.mid - d);
				haplet.arm4.attr("x1", haplet.mid + d);
				haplet.arm3.attr("y2", coords[1]);
				haplet.arm4.attr("y2", coords[1]);

				// Move the balls 
			  	// root.px = event.pageX;
			  	// root.py = event.pageY;
			  	// force.resume();

			}
		});

		// Mouse up event listener - stop moving
		d3.select("#svg-canvas").on("mouseup", function () {
			moving = false;

			// Gracefully return to starting position 
		});



	});

  </script>

</head>

<body>
</body>

</html>
